<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional WebXR Immersive Data Visualization</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; overflow:hidden; background:#111; font-family:Arial; }
#info {
    position:absolute;
    top:10px;
    left:10px;
    color:white;
    background:rgba(0,0,0,0.3);
    padding:6px;
    border-radius:4px;
    z-index:10;
}
</style>
</head>
<body>

<div id="info">
    <b>Immersive Data Visualization</b><br>
    Hover bars to inspect values
</div>

<script type="module">

import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.155.0/examples/jsm/controls/OrbitControls.js';
import { VRButton } from 'https://unpkg.com/three@0.155.0/examples/jsm/webxr/VRButton.js';
import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

//////////////////////////////
// SCENE
//////////////////////////////

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(12,15,20);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);
document.body.appendChild(VRButton.createButton(renderer));

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(4,0,4);
controls.update();

scene.add(new THREE.AmbientLight(0xffffff,0.6));
const light = new THREE.DirectionalLight(0xffffff,0.8);
light.position.set(20,30,20);
scene.add(light);

//////////////////////////////
// LOAD DATA
//////////////////////////////

let bars = [];
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let tooltip;

fetch('data.json')
.then(res => res.json())
.then(data => {

    const maxValue = d3.max(data, d=>d.value);
    const scale = d3.scaleLinear().domain([0,maxValue]).range([0.2,6]);

    data.forEach(d=>{

        const height = scale(d.value);

        const geometry = new THREE.BoxGeometry(1,height,1);
        const material = new THREE.MeshStandardMaterial({
            color:new THREE.Color(`hsl(${(d.value/maxValue)*240},100%,50%)`)
        });

        const bar = new THREE.Mesh(geometry,material);
        bar.position.set(d.x*2,height/2,d.y*2);
        bar.userData.value = d.value;

        scene.add(bar);
        bars.push(bar);
    });

    scene.add(new THREE.GridHelper(20,20));
});

//////////////////////////////
// TOOLTIP
//////////////////////////////

tooltip = document.createElement('div');
tooltip.style.position='absolute';
tooltip.style.color='white';
tooltip.style.background='black';
tooltip.style.padding='4px';
tooltip.style.display='none';
tooltip.style.pointerEvents='none';
document.body.appendChild(tooltip);

//////////////////////////////
// HOVER INTERACTION
//////////////////////////////

window.addEventListener('mousemove', (event)=>{

    mouse.x = (event.clientX/window.innerWidth)*2-1;
    mouse.y = -(event.clientY/window.innerHeight)*2+1;

    raycaster.setFromCamera(mouse,camera);
    const intersects = raycaster.intersectObjects(bars);

    if(intersects.length>0){
        const object = intersects[0].object;

        bars.forEach(b=>b.material.emissive?.setHex(0x000000));
        object.material.emissive.setHex(0x444444);

        tooltip.style.display='block';
        tooltip.style.left=event.clientX+10+'px';
        tooltip.style.top=event.clientY+10+'px';
        tooltip.innerHTML="Value: "+object.userData.value;
    } else {
        tooltip.style.display='none';
        bars.forEach(b=>b.material.emissive?.setHex(0x000000));
    }

});

//////////////////////////////
// RESIZE
//////////////////////////////

window.addEventListener('resize',()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});

//////////////////////////////
// LOOP
//////////////////////////////

renderer.setAnimationLoop(()=>{
renderer.render(scene,camera);
});

</script>
</body>
</html>
